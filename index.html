<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#F6F1EA" />
  <title>PeopleTalk — Wine Gallery</title>

  <style>
    :root{
      --bg:#F6F1EA;
      --panel:rgba(255,255,255,.62);
      --card:rgba(255,255,255,.74);
      --ink:#1F1F1F;
      --muted:#6B6B6B;
      --stroke:rgba(31,31,31,.12);
      --shadow:0 18px 48px rgba(0,0,0,.12);
      --shadow2:0 10px 28px rgba(0,0,0,.10);
      --radius:18px;
      --radius2:22px;
      --chip:#FFFFFF;
      --chipStroke:rgba(31,31,31,.14);
      --accent:#B26A4A;
      --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 600px at 18% 0%, rgba(255,255,255,.65), rgba(255,255,255,0)) , var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:28px 18px 42px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      margin-bottom:18px;
    }

    .brand{
      letter-spacing:.18em;
      font-size:12px;
      color:rgba(31,31,31,.55);
    }

    h1{
      margin:6px 0 6px;
      font-size:40px;
      line-height:1.05;
      font-weight:650;
    }

    .subtitle{
      margin:0;
      color:rgba(31,31,31,.62);
      font-size:16px;
      line-height:1.5;
      max-width:560px;
    }

    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding-top:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:10px 12px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }

    .segmented{
      display:inline-flex;
      background:rgba(255,255,255,.55);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:4px;
      gap:4px;
    }
    .segmented button{
      border:0;
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      color:rgba(31,31,31,.72);
    }
    .segmented button.active{
      background:#fff;
      color:var(--ink);
      box-shadow:0 6px 14px rgba(0,0,0,.10);
    }

    .sortWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 6px;
      color:rgba(31,31,31,.62);
      font-weight:600;
      white-space:nowrap;
    }
    select{
      font-family:var(--font);
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.72);
      padding:8px 12px;
      border-radius:12px;
      outline:none;
      cursor:pointer;
      font-weight:650;
      color:rgba(31,31,31,.82);
    }

    .filters{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin:18px 0 14px;
    }

    .filterBtn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.60);
      color:rgba(31,31,31,.80);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
    }
    .filterBtn.active{
      background:rgba(178,106,74,.14);
      border-color:rgba(178,106,74,.35);
      color:rgba(31,31,31,.92);
    }

    .metaLine{
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(31,31,31,.55);
      font-size:14px;
      margin:10px 0 14px;
    }
    .dot{
      width:7px;height:7px;border-radius:999px;background:var(--accent);
      opacity:.85;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      min-height:170px;
    }
    .card:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .card:active{ transform: translateY(0px); }

    .cardInner{
      display:grid;
      grid-template-columns: 110px 1fr 120px;
      gap:14px;
      align-items:stretch;
    }

    /* IMPORTANT: no gray frame around bottle */
    .bottle{
      width:110px;
      height:160px;         /* enough height to feel "full" */
      display:flex;
      align-items:stretch;
      justify-content:center;
      overflow:visible;     /* no clipping / no rounded frame */
      background:transparent;
      border:0;
      border-radius:0;
    }
    .bottle img{
      width:100%;
      height:100%;
      object-fit:contain;   /* keeps correct proportions */
      display:block;
      border:0;
      border-radius:0;
      background:transparent;
      box-shadow:none;
    }

    .title{
      margin:2px 0 4px;
      font-size:18px;
      line-height:1.15;
      font-weight:760;
    }
    .producer{
      margin:0;
      font-size:14px;
      color:rgba(31,31,31,.72);
      font-weight:650;
    }
    .year{
      margin:2px 0 0;
      font-size:13px;
      color:rgba(31,31,31,.62);
      font-weight:650;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--chipStroke);
      background:rgba(255,255,255,.70);
      font-size:12px;
      color:rgba(31,31,31,.78);
      font-weight:700;
      white-space:nowrap;
    }

    .prices{
      text-align:right;
      color:rgba(31,31,31,.78);
      font-weight:750;
      font-size:13px;
      padding-top:2px;
    }
    .prices .row{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      align-items:baseline;
      margin:2px 0;
    }
    .prices .label{
      font-weight:700;
      color:rgba(31,31,31,.55);
    }
    .prices .val{
      font-size:18px;
      color:rgba(31,31,31,.92);
      font-weight:820;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      background:rgba(246,241,234,.98);
      border:1px solid rgba(31,31,31,.16);
      border-radius:24px;
      box-shadow: 0 28px 80px rgba(0,0,0,.32);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(31,31,31,.10);
    }
    .modalHeader .close{
      border:1px solid rgba(31,31,31,.14);
      background:rgba(255,255,255,.65);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:18px;
      padding:18px;
    }

    /* IMPORTANT: no frame in modal either */
    .modalBottle{
      width:100%;
      height:420px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:0;
      border-radius:0;
    }
    .modalBottle img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      border:0;
      border-radius:0;
      background:transparent;
      box-shadow:none;
    }

    .modalTitle{
      font-size:26px;
      font-weight:850;
      line-height:1.1;
      margin:0 0 6px;
    }
    .modalProducer{
      margin:0 0 10px;
      color:rgba(31,31,31,.72);
      font-weight:750;
    }
    .modalTopRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .modalPrices{
      text-align:right;
      min-width:170px;
    }
    .modalPrices .row{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      align-items:baseline;
      margin:4px 0;
      font-weight:850;
    }
    .modalPrices .label{ color:rgba(31,31,31,.55); font-weight:750; }
    .modalPrices .val{ font-size:22px; color:rgba(31,31,31,.92); }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(31,31,31,.55);
      font-weight:850;
    }
    .block{
      background:rgba(255,255,255,.55);
      border:1px solid rgba(31,31,31,.10);
      border-radius:16px;
      padding:12px 12px;
    }
    .block p{
      margin:0;
      color:rgba(31,31,31,.82);
      font-weight:650;
      line-height:1.45;
      white-space:pre-wrap;
    }

    .hint{
      font-size:12px;
      color:rgba(31,31,31,.50);
      margin-top:8px;
    }

    @media (max-width: 920px){
      header{ flex-direction:column; align-items:flex-start; }
      .toolbar{ justify-content:flex-start; }
      .grid{ grid-template-columns: 1fr; }
      .cardInner{ grid-template-columns: 110px 1fr 110px; }
      .modalBody{ grid-template-columns: 1fr; }
      .modalBottle{ height:320px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">PEOPLETALK · WINE GALLERY</div>
        <h1>Wine Gallery</h1>
        <p class="subtitle">MVP prototype · Live from Google Sheets (CSV)</p>
      </div>

      <div class="toolbar">
        <div class="pill">
          <div class="segmented" aria-label="View switch">
            <button id="viewListBtn" class="active" type="button">List</button>
          </div>
          <div class="sortWrap">
            <span>Sort:</span>
            <select id="sortSelect">
              <option value="curated" selected>Curated order</option>
              <option value="name">Name (A–Z)</option>
              <option value="bottle_desc">Bottle price (high → low)</option>
              <option value="glass_desc">Glass price (high → low)</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <div class="filters" id="filters">
      <button class="filterBtn active" data-section="All" type="button">All</button>
      <button class="filterBtn" data-section="Sparkling" type="button">Sparkling</button>
      <button class="filterBtn" data-section="White" type="button">White</button>
      <button class="filterBtn" data-section="Rosé" type="button">Rosé</button>
      <button class="filterBtn" data-section="Red" type="button">Red</button>
    </div>

    <div class="metaLine">
      <span class="dot"></span>
      <span id="countLine">0 wines · section: All</span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="hint" id="hint"></div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Wine details">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:850;color:rgba(31,31,31,.72)">Wine details</div>
        <button class="close" id="modalClose" type="button">Close</button>
      </div>

      <div class="modalBody">
        <div class="modalBottle">
          <img id="modalImg" alt="" />
        </div>

        <div>
          <div class="modalTopRow">
            <div>
              <h2 class="modalTitle" id="modalTitle"></h2>
              <p class="modalProducer" id="modalProducer"></p>
              <div class="chips" id="modalChips"></div>
            </div>

            <div class="modalPrices" id="modalPrices"></div>
          </div>

          <div id="pairingWrap">
            <div class="sectionTitle">PeopleTalk pairing</div>
            <div class="block"><p id="modalPairPT">—</p></div>

            <div class="sectionTitle">World pairing</div>
            <div class="block"><p id="modalPairWorld">—</p></div>
          </div>

          <div id="extraWrap" style="display:none">
            <div class="sectionTitle">Notes</div>
            <div class="block"><p id="modalNotes">—</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * CONFIG
     * 1) Put your Google Sheet CSV export link here:
     *    - File > Share > Publish to web > CSV
     *    - or a CSV URL you already use
     *****************************************************************/
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7yfiUN3Wgz9vCWrKVJksRoQ6EFYzDq6P40HaN1v2hmhk0nKicji-UZYZyd7LF2-lcSSU264vG53f/pub?gid=178668445&single=true&output=csv";

    // If you already have a working CSV link, paste it here:
    // Example:
    // const CSV_URL = "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv";

    /*****************************************************************
     * Expected columns (case-insensitive):
     * id, section, name, producer, visible, order, bottle_img
     * optional: vintage, year, price_glass, price_bottle, country, region, grape,
     *          pairing_peopletalk, pairing_world, notes
     *****************************************************************/

    const gridEl = document.getElementById("grid");
    const countLine = document.getElementById("countLine");
    const hintEl = document.getElementById("hint");

    const sortSelect = document.getElementById("sortSelect");
    const filtersEl = document.getElementById("filters");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalClose = document.getElementById("modalClose");
    const modalImg = document.getElementById("modalImg");
    const modalTitle = document.getElementById("modalTitle");
    const modalProducer = document.getElementById("modalProducer");
    const modalChips = document.getElementById("modalChips");
    const modalPrices = document.getElementById("modalPrices");
    const modalPairPT = document.getElementById("modalPairPT");
    const modalPairWorld = document.getElementById("modalPairWorld");
    const pairingWrap = document.getElementById("pairingWrap");
    const extraWrap = document.getElementById("extraWrap");
    const modalNotes = document.getElementById("modalNotes");

    let allWines = [];
    let activeSection = "All";

    function normKey(k){
      return String(k || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_");
    }

    function parsePrice(v){
      if(v == null) return null;
      const s = String(v).replace(/[^0-9.]/g,"").trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function safeText(v){
      const s = (v == null) ? "" : String(v).trim();
      return s;
    }

    function toYesNo(v){
      const s = safeText(v).toLowerCase();
      return (s === "yes" || s === "y" || s === "true" || s === "1");
    }

    function csvToRows(text){
      // Simple robust CSV parser (handles quotes)
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const c = text[i];
        const next = text[i+1];

        if(c === '"' ){
          if(inQuotes && next === '"'){
            cur += '"'; i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if(!inQuotes && (c === ",")){
          row.push(cur); cur = "";
          continue;
        }

        if(!inQuotes && (c === "\n")){
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        if(c === "\r") continue;

        cur += c;
      }
      // last cell
      if(cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    function rowsToObjects(rows){
      if(!rows.length) return [];
      const header = rows[0].map(h => normKey(h));
      const objs = [];

      for(let r=1;r<rows.length;r++){
        const line = rows[r];
        if(line.every(x => safeText(x)==="")) continue;

        const o = {};
        for(let i=0;i<header.length;i++){
          o[header[i]] = line[i] ?? "";
        }
        objs.push(o);
      }
      return objs;
    }

    function pick(o, ...keys){
      for(const k of keys){
        const nk = normKey(k);
        if(o[nk] != null && safeText(o[nk]) !== "") return o[nk];
      }
      return "";
    }

    function buildWine(raw){
      // required
      const id = safeText(pick(raw, "id")) || cryptoRandomId();
      const section = safeText(pick(raw, "section")) || "Other";
      const name = safeText(pick(raw, "name"));
      const producer = safeText(pick(raw, "producer"));

      // visibility
      const visible = toYesNo(pick(raw, "visible"));

      // curated order
      const order = Number(safeText(pick(raw, "order")) || 9999);

      // bottle image
      const bottle_img = safeText(pick(raw, "bottle_img"));

      // optional fields
      const vintage = safeText(pick(raw, "vintage", "year")) || ""; // can be NV
      const country = safeText(pick(raw, "country"));
      const region = safeText(pick(raw, "region"));
      const grape = safeText(pick(raw, "grape", "variety"));

      const price_glass = parsePrice(pick(raw, "price_glass", "glass"));
      const price_bottle = parsePrice(pick(raw, "price_bottle", "bottle"));

      const pairing_pt = safeText(pick(raw, "pairing_peopletalk", "peopletalk_pairing", "pairing_pt"));
      const pairing_world = safeText(pick(raw, "pairing_world", "world_pairing"));

      const notes = safeText(pick(raw, "notes", "story", "about"));

      return {
        id, section, name, producer, visible, order,
        bottle_img, vintage, country, region, grape,
        price_glass, price_bottle,
        pairing_pt, pairing_world, notes
      };
    }

    function cryptoRandomId(){
      return "w_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function sortWines(list, mode){
      const arr = [...list];
      if(mode === "name"){
        arr.sort((a,b) => a.name.localeCompare(b.name));
        return arr;
      }
      if(mode === "bottle_desc"){
        arr.sort((a,b) => (b.price_bottle ?? -1) - (a.price_bottle ?? -1));
        return arr;
      }
      if(mode === "glass_desc"){
        arr.sort((a,b) => (b.price_glass ?? -1) - (a.price_glass ?? -1));
        return arr;
      }
      // curated
      arr.sort((a,b) => (a.order - b.order) || a.name.localeCompare(b.name));
      return arr;
    }

    function filterWines(){
      const base = allWines.filter(w => w.visible);
      if(activeSection === "All") return base;
      return base.filter(w => (w.section || "").toLowerCase() === activeSection.toLowerCase());
    }

    function formatMoney(n){
      if(n == null) return "";
      return "$" + Math.round(n).toString();
    }

    function render(){
      const list = sortWines(filterWines(), sortSelect.value);

      // count line
      countLine.textContent = `${list.length} wines · section: ${activeSection}`;

      gridEl.innerHTML = "";
      list.forEach(w => gridEl.appendChild(renderCard(w)));
    }

    function renderCard(w){
      const card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;
      card.setAttribute("role","button");
      card.setAttribute("aria-label", `Open ${w.name}`);

      const inner = document.createElement("div");
      inner.className = "cardInner";

      // Bottle (NO FRAME)
      const bottle = document.createElement("div");
      bottle.className = "bottle";
      const img = document.createElement("img");
      img.alt = w.name || "Wine bottle";
      img.loading = "lazy";
      img.decoding = "async";
      img.referrerPolicy = "no-referrer";
      if(w.bottle_img){
        img.src = w.bottle_img;
      } else {
        // keep empty image (no placeholder frame)
        img.src = "";
      }
      bottle.appendChild(img);

      // Main text
      const main = document.createElement("div");

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = w.name || "—";

      const producer = document.createElement("p");
      producer.className = "producer";
      producer.textContent = w.producer || "—";

      // IMPORTANT: no "Veneto, Italy" line — only year/NV
      const year = document.createElement("p");
      year.className = "year";
      year.textContent = (w.vintage && w.vintage.trim()) ? w.vintage.trim() : "NV";

      const chips = document.createElement("div");
      chips.className = "chips";

      // chips: type(section), country, region (only if exist)
      if(w.section) chips.appendChild(makeChip(w.section));
      if(w.country) chips.appendChild(makeChip(w.country));
      if(w.region) chips.appendChild(makeChip(w.region));

      main.appendChild(title);
      main.appendChild(producer);
      main.appendChild(year);
      main.appendChild(chips);

      // Prices
      const prices = document.createElement("div");
      prices.className = "prices";

      // show Glass only if exists
      if(w.price_glass != null){
        prices.appendChild(priceRow("Glass", formatMoney(w.price_glass), true));
      }
      if(w.price_bottle != null){
        prices.appendChild(priceRow("Bottle", formatMoney(w.price_bottle), true));
      } else {
        // if bottle price missing but glass exists, keep layout okay
        if(w.price_glass == null){
          prices.appendChild(priceRow("—", "—", false));
        }
      }

      inner.appendChild(bottle);
      inner.appendChild(main);
      inner.appendChild(prices);

      card.appendChild(inner);

      // Open modal
      card.addEventListener("click", () => openModal(w));
      card.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openModal(w);
        }
      });

      return card;
    }

    function makeChip(text){
      const c = document.createElement("span");
      c.className = "chip";
      c.textContent = text;
      return c;
    }

    function priceRow(label, value, emphasize){
      const row = document.createElement("div");
      row.className = "row";
      const l = document.createElement("span");
      l.className = "label";
      l.textContent = label;

      const v = document.createElement("span");
      v.className = emphasize ? "val" : "label";
      v.textContent = value;

      row.appendChild(l);
      row.appendChild(v);
      return row;
    }

    function openModal(w){
      modalTitle.textContent = w.name || "—";
      modalProducer.textContent = w.producer || "—";

      // Bottle (NO FRAME)
      modalImg.alt = w.name || "Wine bottle";
      modalImg.referrerPolicy = "no-referrer";
      modalImg.src = w.bottle_img || "";

      // chips in modal too
      modalChips.innerHTML = "";
      if(w.section) modalChips.appendChild(makeChip(w.section));
      if(w.country) modalChips.appendChild(makeChip(w.country));
      if(w.region) modalChips.appendChild(makeChip(w.region));
      if(w.vintage) modalChips.appendChild(makeChip(w.vintage));
      if(w.grape) modalChips.appendChild(makeChip(w.grape));

      // prices
      modalPrices.innerHTML = "";
      if(w.price_glass != null){
        modalPrices.appendChild(modalPriceRow("Glass", formatMoney(w.price_glass)));
      }
      if(w.price_bottle != null){
        modalPrices.appendChild(modalPriceRow("Bottle", formatMoney(w.price_bottle)));
      }

      // pairings ONLY inside modal
      const hasPT = (w.pairing_pt && w.pairing_pt.trim());
      const hasWorld = (w.pairing_world && w.pairing_world.trim());
      if(hasPT || hasWorld){
        pairingWrap.style.display = "";
        modalPairPT.textContent = hasPT ? w.pairing_pt : "—";
        modalPairWorld.textContent = hasWorld ? w.pairing_world : "—";
      } else {
        pairingWrap.style.display = "none";
      }

      // optional notes
      if(w.notes && w.notes.trim()){
        extraWrap.style.display = "";
        modalNotes.textContent = w.notes;
      } else {
        extraWrap.style.display = "none";
      }

      modalBackdrop.style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function modalPriceRow(label, value){
      const row = document.createElement("div");
      row.className = "row";
      const l = document.createElement("span");
      l.className = "label";
      l.textContent = label;

      const v = document.createElement("span");
      v.className = "val";
      v.textContent = value || "—";

      row.appendChild(l);
      row.appendChild(v);
      return row;
    }

    function closeModal(){
      modalBackdrop.style.display = "none";
      document.body.style.overflow = "";
    }

    modalBackdrop.addEventListener("click", (e) => {
      if(e.target === modalBackdrop) closeModal();
    });
    modalClose.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && modalBackdrop.style.display === "flex") closeModal();
    });

    // Filters
    filtersEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".filterBtn");
      if(!btn) return;
      activeSection = btn.dataset.section || "All";
      [...filtersEl.querySelectorAll(".filterBtn")].forEach(b => b.classList.toggle("active", b === btn));
      render();
    });

    // Sort
    sortSelect.addEventListener("change", render);

    async function loadData(){
      // If CSV_URL empty, show hint
      if(!CSV_URL){
        hintEl.textContent = "CSV_URL is not set. Paste your Google Sheets CSV link into CSV_URL in the code.";
        return;
      }

      hintEl.textContent = "Loading…";
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if(!res.ok){
        hintEl.textContent = `Failed to load CSV: ${res.status}`;
        return;
      }
      const text = await res.text();

      const rows = csvToRows(text);
      const objs = rowsToObjects(rows);

      allWines = objs.map(buildWine);

      hintEl.textContent = "";
      render();
    }

    // START
    loadData().catch(err => {
      console.error(err);
      hintEl.textContent = "Error loading CSV. Check console.";
    });
  </script>

  <script>
    /*****************************************************************
     * QUICK OVERRIDE (optional)
     * If you want to set CSV without editing the main script:
     * window.CSV_URL_OVERRIDE = "YOUR_CSV_LINK";
     *****************************************************************/
    // window.CSV_URL_OVERRIDE = "PASTE_YOUR_CSV_LINK_HERE";
  </script>
</body>
</html>
