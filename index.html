<!-- БЛОК 01: Каркас документа (HTML) — структура страницы и контейнеры: шапка, фильтры, сетка, статус/ошибки, модалка -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PeopleTalk — Wine Gallery</title>

  <!-- БЛОК 02: Стили (CSS) — тема (цвета/шрифты), раскладка, карточки, модалка, адаптив -->
  <style>
    /* БЛОК 02.1: CSS-переменные (токены темы) */
    :root{
      --bg:#F6F1EA;
      --card:#FFFBF6;
      --text:#151515;
      --muted:#6F6F6F;
      --line:rgba(0,0,0,.10);
      --shadow:0 14px 40px rgba(0,0,0,.08);
      --shadow2:0 10px 24px rgba(0,0,0,.10);
      --accent:#B26A4A; /* terracotta */
      --radius:18px;
      --radius2:22px;
      --pad:18px;
      --max:1120px;
      --font: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* БЛОК 02.2: Макет страницы (обертка/шапка) */
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:28px 18px 64px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand .kicker{
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:12px;
      color:rgba(0,0,0,.55);
    }
    .brand h1{
      margin:0;
      font-size:34px;
      letter-spacing:-.02em;
      line-height:1.08;
    }
    .brand .sub{
      margin:0;
      color:rgba(0,0,0,.62);
      max-width:560px;
    }

    .topRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.60);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .pill label{
      font-size:13px;
      color:rgba(0,0,0,.60);
      margin-right:2px;
    }
    select{
      border:0;
      background:transparent;
      font:inherit;
      font-size:14px;
      outline:none;
      color:rgba(0,0,0,.84);
      padding-right:4px;
    }

    /* БЛОК 02.4: Фильтры (табы секций) */
    .filtersRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin:18px 0 10px;
    }

    .seg{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.45);
      border-radius:999px;
    }

    .seg button{
      appearance:none;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.65);
      color:rgba(0,0,0,.82);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font:inherit;
      font-size:14px;
      line-height:1;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .seg button:active{ transform:scale(.98); }
    .seg button.active{
      border-color:rgba(178,106,74,.45);
      background:rgba(178,106,74,.12);
    }

    .metaLine{
      display:flex;
      align-items:center;
      gap:10px;
      color:rgba(0,0,0,.60);
      margin:10px 2px 14px;
      font-size:14px;
    }
    .dot{
      width:7px;height:7px;border-radius:99px;
      background:var(--accent);
      box-shadow:0 0 0 5px rgba(178,106,74,.12);
    }

    /* БЛОК 02.5: Сетка карточек */
    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:18px;
    }

    @media (max-width: 900px){
      header{ align-items:flex-start; }
      .brand h1{ font-size:30px; }
      .grid{ grid-template-columns:1fr; }
      .topRight{ justify-content:flex-start; }
    }

    /* БЛОК 02.6: Карточка вина (бутылка, текст, чипсы, цены) */
    .card{
      position:relative;
      background:var(--card);
      border:1px solid rgba(0,0,0,.10);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      padding:16px;
      cursor:pointer;
      overflow:hidden;
      transition:transform .08s ease, box-shadow .15s ease;
      min-height:170px;
    }
    .card:hover{ box-shadow:var(--shadow2); }
    .card:active{ transform:translateY(1px); }

    .cardInner{
      display:grid;
      grid-template-columns:120px 1fr 120px;
      gap:14px;
      align-items:start;
    }

    @media (max-width: 520px){
      .cardInner{
        grid-template-columns:110px 1fr;
        grid-template-areas:
          "img  prices"
          "info info";
      }
      .prices{ grid-area:prices; justify-self:end; }
      .imgCol{ grid-area:img; }
      .infoCol{ grid-area:info; }
    }

    /* Бутылка (без рамки/серого блока вокруг) */
    .imgCol{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2px 0;
    }
    .bottle{
      height:150px; /* стандартная высота бутылки на карточке */
      width:auto;
      max-width:110px;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 12px 18px rgba(0,0,0,.14));
    }

    .infoCol h3{
      margin:0 0 6px;
      font-size:18px;
      line-height:1.18;
      letter-spacing:-.01em;
    }
    .producer{
      margin:0;
      color:rgba(0,0,0,.70);
      font-size:14px;
      line-height:1.25;
    }
    .vintage{
      margin:6px 0 0;
      color:rgba(0,0,0,.55);
      font-size:13px;
    }

    .chips{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.60);
      color:rgba(0,0,0,.72);
      line-height:1;
      user-select:none;
    }

    .prices{
      text-align:right;
      color:rgba(0,0,0,.84);
      font-size:13px;
      line-height:1.25;
      padding-top:2px;
      min-width:110px;
    }
    .prices .row{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin:2px 0;
      white-space:nowrap;
    }
    .prices .lbl{ color:rgba(0,0,0,.55); }
    .prices .val{
      font-weight:700;
      font-size:18px;
      letter-spacing:-.01em;
    }

    /* БЛОК 02.7: Статус загрузки и ошибки */
    .status{
      margin:22px 0 0;
      color:rgba(0,0,0,.62);
      font-size:14px;
    }
    .error{
      color:#9a1a1a;
      background:rgba(154,26,26,.06);
      border:1px solid rgba(154,26,26,.18);
      padding:12px 14px;
      border-radius:14px;
      margin-top:12px;
      white-space:pre-wrap;
    }

    /* БЛОК 02.8: Модалка (оверлей, раскладка, размер бутылки) */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width:min(860px, 100%);
      background:var(--card);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      box-shadow:0 24px 80px rgba(0,0,0,.28);
      overflow:hidden;
    }

    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      padding:16px 16px 0 16px;
    }

    .closeBtn{
      appearance:none;
      border:1px solid rgba(0,0,0,.14);
      background:rgba(255,255,255,.70);
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font:inherit;
      color:rgba(0,0,0,.75);
    }

    .modalBody{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:18px;
      padding:14px 16px 18px 16px;
    }

    @media (max-width: 720px){
      .modalBody{ grid-template-columns:1fr; }
    }

    .modalBottleWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:6px 0 2px;
    }
    .modalBottle{
      height:280px; /* больше, чем на карточке, но не гигантская */
      width:auto;
      max-width:240px;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 18px 26px rgba(0,0,0,.18));
    }

    .modalTitle{
      margin:0 0 6px;
      font-size:22px;
      line-height:1.15;
      letter-spacing:-.02em;
    }
    .modalProducer{
      margin:0;
      color:rgba(0,0,0,.70);
    }
    .modalVintage{
      margin:6px 0 10px;
      color:rgba(0,0,0,.55);
      font-size:14px;
    }

    .sectionHdr{
      margin:16px 0 8px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-size:12px;
      color:rgba(0,0,0,.55);
    }
    .pairingText, .storyText, .notesText{
      margin:0;
      color:rgba(0,0,0,.80);
      line-height:1.5;
      white-space:pre-wrap;
    }
  </style>

  <!-- БЛОК 03: Тело страницы (HTML) — шапка, фильтры, сетка, статус/ошибки и DOM модалки -->
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="kicker">PeopleTalk · Wine Gallery</div>
        <h1>Wine Gallery</h1>
        <p class="sub">Minimal gallery. Tap a wine to open details.</p>
      </div>

      <div class="topRight">
        <div class="pill">
          <label for="sortSel">Sort:</label>
          <select id="sortSel">
            <option value="curated">Curated order</option>
            <option value="name_asc">Name A → Z</option>
            <option value="bottle_low">Bottle price: low → high</option>
            <option value="glass_low">Glass price: low → high</option>
          </select>
        </div>
      </div>
    </header>

    <div class="filtersRow">
      <div class="seg" id="sectionSeg"></div>
    </div>

    <div class="metaLine">
      <span class="dot"></span>
      <span id="countLine">—</span>
    </div>

    <div id="grid" class="grid"></div>

    <div id="status" class="status">Loading wines…</div>
    <div id="err" class="error" style="display:none;"></div>
  </div>

  <!-- Модалка -->
  <div id="overlay" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalTop">
        <div></div>
        <button class="closeBtn" id="closeBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="modalBottleWrap">
          <img id="mBottle" class="modalBottle" alt="" />
        </div>
        <div>
          <h2 id="mTitle" class="modalTitle"></h2>
          <p id="mProducer" class="modalProducer"></p>
          <p id="mVintage" class="modalVintage"></p>

          <div class="chips" id="mChips"></div>

          <div class="sectionHdr">Prices</div>
          <p class="notesText" id="mPrices"></p>

          <div class="sectionHdr">PeopleTalk pairing</div>
          <p class="pairingText" id="mPairing"></p>

          <div class="sectionHdr" id="storyHdr" style="display:none;">Story</div>
          <p class="storyText" id="mStory" style="display:none;"></p>

          <div class="sectionHdr" id="notesHdr" style="display:none;">Notes</div>
          <p class="notesText" id="mNotes" style="display:none;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- БЛОК 04: Логика приложения (JS) — загрузка/парсинг CSV, состояние, рендер, модалка -->
  <script>
    // ===== Конфиг =====
    // БЛОК 04.1: Конфиг — ссылка на CSV (+ возможные флаги)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7yfiUN3Wgz9vCWrKVJksRoQ6EFYzDq6P40HaN1v2hmhk0nKicji-UZYZyd7LF2-lcSSU264vG53f/pub?gid=178668445&single=true&output=csv";

    // ===== Хелперы =====
    // БЛОК 04.2: Хелперы — статус/ошибки, CSV-парсер, форматирование, сбор чипсов
    function showError(msg){
      const el = document.getElementById("err");
      el.style.display = "block";
      el.textContent = msg;
    }
    function setStatus(msg){
      document.getElementById("status").textContent = msg;
    }

    // Надёжный CSV-парсер (поддерживает кавычки/запятые/переносы строк)
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(inQuotes){
          if(ch === '"' && next === '"'){ cur += '"'; i++; }
          else if(ch === '"'){ inQuotes = false; }
          else { cur += ch; }
        } else {
          if(ch === '"'){ inQuotes = true; }
          else if(ch === ","){ row.push(cur); cur = ""; }
          else if(ch === "\n"){
            row.push(cur); cur = "";
            if(row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
            row = [];
          } else if(ch === "\r"){
            // игнорируем
          } else {
            cur += ch;
          }
        }
      }
      row.push(cur);
      if(row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);

      if(rows.length === 0) return [];

      const headers = rows[0].map(h => (h || "").trim());
      const data = [];
      for(let r=1;r<rows.length;r++){
        const obj = {};
        const line = rows[r];
        headers.forEach((h, idx) => { obj[h] = (line[idx] ?? "").trim(); });
        data.push(obj);
      }
      return data;
    }

    function normYes(v){
      return String(v || "").trim().toLowerCase() === "yes";
    }
    function num(v){
      const s = String(v || "").trim();
      if(!s) return NaN;
      const n = Number(s.replace(/[^0-9.\-]/g,""));
      return Number.isFinite(n) ? n : NaN;
    }
    function safeText(v){
      const s = String(v ?? "").trim();
      return s;
    }

    function buildChips(w){
      // Чипсы оставляем на карточке (section/country/region),
      // и НЕ дублируем "Veneto, Italy" отдельной строкой текста.
      const chips = [];
      if(safeText(w.section)) chips.push(safeText(w.section));
      if(safeText(w.country)) chips.push(safeText(w.country));
      if(safeText(w.region))  chips.push(safeText(w.region));
      return chips;
    }

    function formatPrice(n){
      if(!Number.isFinite(n)) return null;
      return "$" + Math.round(n);
    }

    // ===== Состояние =====
    // БЛОК 04.3: Состояние — список вин в памяти + текущая секция
    let ALL = [];
    let currentSection = "All";

    // ===== Рендер =====
    // БЛОК 04.4: Рендер — кнопки секций, сортировка, HTML карточек, сетка, счётчик
    function renderSections(){
      const seg = document.getElementById("sectionSeg");
      seg.innerHTML = "";

      const sections = Array.from(new Set(ALL.map(w => safeText(w.section)).filter(Boolean)));
      const ordered = ["All", ...sections];

      for(const s of ordered){
        const btn = document.createElement("button");
        btn.textContent = s;
        btn.className = (s === currentSection) ? "active" : "";
        btn.addEventListener("click", () => {
          currentSection = s;
          renderAll();
        });
        seg.appendChild(btn);
      }
    }

    function applyFilterAndSort(){
      let items = ALL.slice();

      if(currentSection !== "All"){
        items = items.filter(w => safeText(w.section) === currentSection);
      }

      const sortVal = document.getElementById("sortSel").value;

      if(sortVal === "curated"){
        items.sort((a,b) => {
          const oa = num(a.order);
          const ob = num(b.order);
          if(Number.isFinite(oa) && Number.isFinite(ob) && oa !== ob) return oa - ob;

          const sa = safeText(a.section);
          const sb = safeText(b.section);
          if(sa !== sb) return sa.localeCompare(sb);

          return safeText(a.name).localeCompare(safeText(b.name));
        });
      } else if(sortVal === "name_asc"){
        items.sort((a,b)=> safeText(a.name).localeCompare(safeText(b.name)));
      } else if(sortVal === "bottle_low"){
        items.sort((a,b)=> (num(a.bottle_price) || 999999) - (num(b.bottle_price) || 999999));
      } else if(sortVal === "glass_low"){
        items.sort((a,b)=> (num(a.btg_price) || 999999) - (num(b.btg_price) || 999999));
      }

      return items;
    }

    function renderCount(n){
      const label = `${n} wines · section: ${currentSection}`;
      document.getElementById("countLine").textContent = label;
    }

    function cardHTML(w){
      const chips = buildChips(w);
      const btg = formatPrice(num(w.btg_price));
      const bot = formatPrice(num(w.bottle_price));

      // Цены: показываем Glass только если есть, Bottle только если есть
      const rows = [];
      if(btg) rows.push(`<div class="row"><span class="lbl">Glass</span><span class="val">${btg}</span></div>`);
      if(bot) rows.push(`<div class="row"><span class="lbl">Bottle</span><span class="val">${bot}</span></div>`);
      if(rows.length === 0) rows.push(`<div class="row"><span class="lbl">—</span><span class="val">—</span></div>`);

      const img = safeText(w.bottle_img);
      const name = safeText(w.name);
      const producer = safeText(w.producer);
      const vintage = safeText(w.vintage) || "NV";

      return `
        <div class="card" data-id="${safeText(w.id)}" tabindex="0" role="button" aria-label="Open ${escapeHtml(name)}">
          <div class="cardInner">
            <div class="imgCol">
              <img class="bottle" src="${escapeAttr(img)}" alt="${escapeAttr(name)}" loading="lazy" decoding="async" />
            </div>

            <div class="infoCol">
              <h3>${escapeHtml(name)}</h3>
              <p class="producer">${escapeHtml(producer)}</p>
              <p class="vintage">${escapeHtml(vintage)}</p>

              <div class="chips">
                ${chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join("")}
              </div>
            </div>

            <div class="prices">
              ${rows.join("")}
            </div>
          </div>
        </div>
      `;
    }

    function renderGrid(items){
      const grid = document.getElementById("grid");
      grid.innerHTML = items.map(cardHTML).join("");

      // Клик по карточке + поддержка клавиатуры
      grid.querySelectorAll(".card").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const wine = ALL.find(w => safeText(w.id) === id);
          if(wine) openModal(wine);
        });
        el.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            el.click();
          }
        });
      });
    }

    function renderAll(){
      renderSections();
      const items = applyFilterAndSort();
      renderCount(items.length);
      renderGrid(items);
      setStatus(items.length ? "" : "No wines to display.");
    }

    // ===== Модалка =====
    // БЛОК 04.5: Модалка — открытие/закрытие + заполнение полей
    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("closeBtn");

    function openModal(w){
      // Бутылка
      document.getElementById("mBottle").src = safeText(w.bottle_img);
      document.getElementById("mBottle").alt = safeText(w.name);

      // Текст
      document.getElementById("mTitle").textContent = safeText(w.name);
      document.getElementById("mProducer").textContent = safeText(w.producer);

      const vint = safeText(w.vintage) || "NV";
      document.getElementById("mVintage").textContent = vint;

      // Чипсы
      const chips = buildChips(w);
      const mChips = document.getElementById("mChips");
      mChips.innerHTML = chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join("");

      // Цены
      const btg = formatPrice(num(w.btg_price));
      const bot = formatPrice(num(w.bottle_price));
      let priceText = "";
      if(btg) priceText += `Glass: ${btg}\n`;
      if(bot) priceText += `Bottle: ${bot}\n`;
      if(!priceText) priceText = "—";
      document.getElementById("mPrices").textContent = priceText.trim();

      // Пэринг (ТОЛЬКО PeopleTalk)
      const pairing = safeText(w.pairing_PeopleTalk);
      document.getElementById("mPairing").textContent = pairing ? pairing : "—";

      // Story / Notes (опционально: только если заполнены)
      const story = safeText(w.story_short);
      const notes = safeText(w.notes);

      const storyHdr = document.getElementById("storyHdr");
      const notesHdr = document.getElementById("notesHdr");
      const mStory = document.getElementById("mStory");
      const mNotes = document.getElementById("mNotes");

      if(story){
        storyHdr.style.display = "";
        mStory.style.display = "";
        mStory.textContent = story;
      } else {
        storyHdr.style.display = "none";
        mStory.style.display = "none";
        mStory.textContent = "";
      }

      if(notes){
        notesHdr.style.display = "";
        mNotes.style.display = "";
        mNotes.textContent = notes;
      } else {
        notesHdr.style.display = "none";
        mNotes.style.display = "none";
        mNotes.textContent = "";
      }

      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    closeBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeModal();
    });
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && overlay.classList.contains("open")) closeModal();
    });

    // ===== Экранирование =====
    // БЛОК 04.6: Экранирование — защита HTML/атрибутов
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function escapeAttr(str){
      // Строка, безопасная для атрибутов
      return escapeHtml(str).replace(/`/g,"&#096;");
    }

    // ===== Загрузка данных =====
    // БЛОК 04.7: Загрузка — fetch CSV, парсинг, фильтр visible, маппинг колонок, рендер
    async function load(){
      try{
        setStatus("Loading wines…");
        const res = await fetch(CSV_URL, { cache:"no-store" });
        if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();

        const parsed = parseCSV(text);

        // Оставляем только visible == yes
        const visible = parsed.filter(w => normYes(w.visible));

        // Базовая проверка: требуется name + bottle_img
        ALL = visible
          .filter(w => safeText(w.name))
          .map(w => ({
            id: w.id,
            section: w.section,
            name: w.name,
            producer: w.producer,
            country: w.country,
            region: w.region,
            vintage: w.vintage,
            grape: w.grape,
            style: w.style,
            btg_price: w.btg_price,
            bottle_price: w.bottle_price,
            pairing_PeopleTalk: w.pairing_PeopleTalk,
            pairing_World_Classic: w.pairing_World_Classic,
            story_short: w.story_short,
            notes: w.notes,
            visible: w.visible,
            order: w.order,
            bottle_img: w.bottle_img
          }));

        document.getElementById("sortSel").addEventListener("change", renderAll);

        if(ALL.length === 0){
          setStatus("No wines found (visible=yes).");
        } else {
          setStatus("");
        }

        renderAll();
      } catch(err){
        setStatus("");
        showError(String(err));
      }
    }

    load();
  </script>
</body>
</html>
