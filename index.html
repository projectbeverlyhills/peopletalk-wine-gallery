<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PeopleTalk — Wine Gallery</title>

  <style>
    :root{
      --bg:#f6f1ea;
      --card:#fffdf9;
      --ink:#1f1f1f;
      --muted:#6b6b6b;
      --stroke:rgba(31,31,31,.10);
      --shadow:0 14px 38px rgba(0,0,0,.08);
      --radius:22px;
      --accent:#c59a7c;
      --chip:#ffffff;
      --chipStroke:rgba(31,31,31,.14);
      --font: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:28px 22px 60px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:18px;flex-wrap:wrap}
    .brand{
      letter-spacing:.12em;
      font-size:12px;
      color:rgba(31,31,31,.55);
      text-transform:uppercase;
      margin-bottom:8px;
    }
    h1{margin:0;font-size:40px;line-height:1.05}
    .sub{margin-top:8px;color:rgba(31,31,31,.55);max-width:620px}

    .controls{
      margin-top:18px;
      display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;
      padding:16px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.35);
      backdrop-filter:saturate(1.2) blur(6px);
    }

    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--chipStroke);
      background:var(--chip);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      color:var(--ink);
      user-select:none;
      touch-action:manipulation;
    }
    .tab.active{
      border-color:rgba(197,154,124,.55);
      box-shadow:0 0 0 3px rgba(197,154,124,.16) inset;
    }

    .rightControls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .select{
      border:1px solid var(--chipStroke);
      background:var(--chip);
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      color:var(--ink);
      touch-action:manipulation;
    }

    .metaLine{
      margin:14px 6px 0;
      color:rgba(31,31,31,.55);
      display:flex;align-items:center;gap:8px;
      font-size:14px;
    }
    .dot{width:7px;height:7px;border-radius:999px;background:var(--accent);display:inline-block}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:18px;
    }

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      display:grid;
      grid-template-columns:200px 1fr; /* больше места бутылке */
      gap:16px;
      align-items:stretch;
      cursor:pointer;
      position:relative;
      outline:none;
      touch-action:manipulation;
    }
    .card:focus{
      box-shadow:0 0 0 4px rgba(197,154,124,.18), var(--shadow);
      border-color:rgba(197,154,124,.55);
    }

    /* Bottle: NO frame, try "full height" */
    .bottleSlot{
      height:100%;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:0;
      min-height:170px;
    }
    .bottleSlot img{
      height:100%;
      width:auto;
      max-width:100%;
      object-fit:contain;
      display:block;
    }

    .titleRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .name{font-weight:650;font-size:20px;line-height:1.12;margin:0}
    .producer{margin-top:4px;color:rgba(31,31,31,.70);font-size:14px}
    .vintage{margin-top:2px;color:rgba(31,31,31,.55);font-size:14px}

    .prices{
      text-align:right;
      white-space:nowrap;
      font-size:13px;
      color:rgba(31,31,31,.62);
      margin-left:auto;
      min-width:110px;
    }
    .prices b{color:var(--ink);font-size:18px}
    .prices .row{display:flex;justify-content:flex-end;gap:8px;align-items:baseline}

    .chips{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--chipStroke);
      background:var(--chip);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:rgba(31,31,31,.78);
    }

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.38);
      display:none;
      align-items:center;
      justify-content:center;
      padding:22px;
      z-index:999;
    }
    .modal{
      width:min(920px, 100%);
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:28px;
      box-shadow:0 22px 60px rgba(0,0,0,.22);
      overflow:hidden;
      display:grid;
      grid-template-columns:320px 1fr;
    }
    .modalLeft{
      padding:18px;
      background:rgba(255,255,255,.45);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modalLeft img{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
    }
    .modalRight{padding:18px 18px 22px}
    .modalTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .closeBtn{
      border:1px solid var(--chipStroke);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-size:14px;
      touch-action:manipulation;
    }
    .blockTitle{
      margin-top:14px;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(31,31,31,.55);
    }
    .blockBody{
      margin-top:8px;
      color:rgba(31,31,31,.85);
      font-size:15px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .card{grid-template-columns:170px 1fr}
      h1{font-size:34px}
      .modal{grid-template-columns:1fr}
      .modalLeft{display:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">PEOPLETALK • WINE GALLERY</div>
        <h1>Wine Gallery</h1>
        <div class="sub">Minimal list. Tap a wine to open details and pairing.</div>
      </div>
    </div>

    <div class="controls">
      <div class="tabs" id="tabs"></div>
      <div class="rightControls">
        <select class="select" id="sort">
          <option value="curated" selected>Curated order</option>
          <option value="name_asc">Name A→Z</option>
          <option value="price_bottle_asc">Bottle price low→high</option>
          <option value="price_bottle_desc">Bottle price high→low</option>
        </select>
      </div>
    </div>

    <div class="metaLine" id="metaLine"><span class="dot"></span> Loading…</div>
    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalLeft">
        <img id="mImg" alt="" />
      </div>
      <div class="modalRight">
        <div class="modalTop">
          <div>
            <div class="name" id="mName"></div>
            <div class="producer" id="mProducer"></div>
            <div class="vintage" id="mVintage"></div>
            <div class="chips" id="mChips"></div>
          </div>
          <button class="closeBtn" id="closeBtn">Close</button>
        </div>

        <div class="blockTitle">Prices</div>
        <div class="blockBody" id="mPrices"></div>

        <div class="blockTitle">PeopleTalk pairing</div>
        <div class="blockBody" id="mPairing"></div>
      </div>
    </div>
  </div>

  <script>
    // ✅ YOUR CSV (already set)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7yfiUN3Wgz9vCWrKVJksRoQ6EFYzDq6P40HaN1v2hmhk0nKicji-UZYZyd7LF2-lcSSU264vG53f/pub?gid=178668445&single=true&output=csv";

    // Tabs order you want
    const SECTIONS = ["All","Sparkling","White","Rosé","Red"];

    let allRows = [];
    let activeSection = "All";

    const $ = (id)=>document.getElementById(id);

    function parseCSV(text){
      // CSV parser (handles commas + quotes)
      const out=[[]];
      let i=0, field="", inQuotes=false;

      while(i<text.length){
        const c=text[i];
        if(c === '"'){
          if(inQuotes && text[i+1] === '"'){ field+='"'; i++; }
          else inQuotes = !inQuotes;
        } else if(c === ',' && !inQuotes){
          out[out.length-1].push(field); field="";
        } else if((c === '\n' || c === '\r') && !inQuotes){
          if(c === '\r' && text[i+1] === '\n') i++;
          out[out.length-1].push(field); field="";
          if(out[out.length-1].some(v=>String(v).trim()!=="")) out.push([]);
        } else {
          field += c;
        }
        i++;
      }
      out[out.length-1].push(field);

      const header = out[0].map(h=>String(h||"").trim());
      const rows = [];

      for(let r=1;r<out.length;r++){
        const obj = {};
        for(let c=0;c<header.length;c++){
          const key = header[c];
          if(!key) continue;
          obj[key] = String(out[r][c] ?? "").trim();
        }
        // skip fully empty
        if(Object.values(obj).some(v=>String(v).trim() !== "")) rows.push(obj);
      }
      return rows;
    }

    function getAny(row, keys){
      for(const k of keys){
        if(row[k] != null && String(row[k]).trim() !== "") return String(row[k]).trim();
      }
      return "";
    }

    function numFromAny(row, keys){
      const raw = getAny(row, keys);
      if(!raw) return null;
      const s = String(raw).replace(/[^0-9.]/g,'').trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function fmtMoney(n){
      if(n==null) return "";
      return "$" + n.toFixed(0);
    }

    function visibleYes(row){
      return String(getAny(row, ["visible"])).toLowerCase() === "yes";
    }

    function buildTabs(){
      const tabs = $("tabs");
      tabs.innerHTML = "";
      SECTIONS.forEach(sec=>{
        const b = document.createElement("div");
        b.className = "tab" + (sec===activeSection ? " active":"");
        b.textContent = sec;
        b.onclick = ()=>{
          activeSection = sec;
          document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          render();
        };
        tabs.appendChild(b);
      });
    }

    function chipList(row){
      // show only what exists; section is always useful
      const chips = [];
      const section = getAny(row, ["section"]);
      if(section) chips.push(section);

      const country = getAny(row, ["country","Country"]);
      if(country) chips.push(country);

      const region = getAny(row, ["region","Region"]);
      if(region) chips.push(region);

      return chips;
    }

    function getFiltered(){
      let rows = allRows.filter(visibleYes);

      if(activeSection !== "All"){
        rows = rows.filter(r => getAny(r, ["section"]) === activeSection);
      }
      return rows;
    }

    function getSorted(rows){
      const mode = $("sort").value;
      const copy = rows.slice();

      if(mode === "curated"){
        copy.sort((a,b)=> (numFromAny(a,["order"])||9999) - (numFromAny(b,["order"])||9999));
        return copy;
      }

      if(mode === "name_asc"){
        copy.sort((a,b)=> getAny(a,["name"]).localeCompare(getAny(b,["name"])));
        return copy;
      }

      if(mode === "price_bottle_asc"){
        copy.sort((a,b)=> (numFromAny(a,["bottle_price","bottle","price_bottle"])??999999) - (numFromAny(b,["bottle_price","bottle","price_bottle"])??999999));
        return copy;
      }

      if(mode === "price_bottle_desc"){
        copy.sort((a,b)=> (numFromAny(b,["bottle_price","bottle","price_bottle"])??-1) - (numFromAny(a,["bottle_price","bottle","price_bottle"])??-1));
        return copy;
      }

      return copy;
    }

    function render(){
      const rows = getSorted(getFiltered());

      $("metaLine").innerHTML =
        `<span class="dot"></span> ${rows.length} wines · section: ${activeSection}`;

      const grid = $("grid");
      grid.innerHTML = "";

      rows.forEach(row=>{
        const name = getAny(row, ["name"]);
        const producer = getAny(row, ["producer"]);
        const vintage = getAny(row, ["vintage","year","Year","NV"]);

        // bottle_img (your column R)
        const img = getAny(row, ["bottle_img","bottle_img_url","image","img"]);

        // prices: supports multiple possible column names
        const glass = numFromAny(row, ["glass_price","glass","btg_price","btg","price_glass","glassPrice"]);
        const bottle = numFromAny(row, ["bottle_price","bottle","price_bottle","bottlePrice"]);

        let priceHTML = "";
        if(glass != null || bottle != null){
          const lines = [];
          if(glass != null) lines.push(`<div class="row"><span>Glass</span><b>${fmtMoney(glass)}</b></div>`);
          if(bottle != null) lines.push(`<div class="row"><span>Bottle</span><b>${fmtMoney(bottle)}</b></div>`);
          priceHTML = `<div class="prices">${lines.join("")}</div>`;
        } else {
          priceHTML = `<div class="prices"></div>`;
        }

        const chips = chipList(row).map(x=>`<span class="chip">${x}</span>`).join("");

        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");

        card.innerHTML = `
          <div class="bottleSlot">
            ${img ? `<img src="${img}" alt="${name.replaceAll('"','')}" loading="lazy" />` : ""}
          </div>

          <div>
            <div class="titleRow">
              <div>
                <div class="name">${name}</div>
                <div class="producer">${producer}</div>
                <div class="vintage">${vintage}</div>
              </div>
              ${priceHTML}
            </div>

            <div class="chips">${chips}</div>
          </div>
        `;

        const open = ()=>openModal(row);
        card.addEventListener("click", open, {passive:true});
        card.addEventListener("keydown", (e)=>{ if(e.key === "Enter") open(); });

        grid.appendChild(card);
      });
    }

    function openModal(row){
      const overlay = $("overlay");
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden","false");

      const name = getAny(row, ["name"]);
      const producer = getAny(row, ["producer"]);
      const vintage = getAny(row, ["vintage","year","Year","NV"]);
      const img = getAny(row, ["bottle_img","bottle_img_url","image","img"]);

      $("mName").textContent = name;
      $("mProducer").textContent = producer;
      $("mVintage").textContent = vintage;

      $("mImg").src = img || "";
      $("mImg").alt = name || "";

      $("mChips").innerHTML = chipList(row).map(x=>`<span class="chip">${x}</span>`).join("");

      const glass = numFromAny(row, ["glass_price","glass","btg_price","btg","price_glass","glassPrice"]);
      const bottle = numFromAny(row, ["bottle_price","bottle","price_bottle","bottlePrice"]);

      const lines = [];
      if(glass != null) lines.push(`Glass: ${fmtMoney(glass)}`);
      if(bottle != null) lines.push(`Bottle: ${fmtMoney(bottle)}`);
      $("mPrices").textContent = lines.length ? lines.join("\n") : "—";

      // ✅ PeopleTalk pairing ONLY (no world pairing)
      const pairing = getAny(row, [
        "pairing_peopletalk",
        "peopletalk_pairing",
        "PeopleTalk",
        "peopletalk",
        "pairing",
        "pairing_pt"
      ]);

      $("mPairing").textContent = pairing || "—";
    }

    function closeModal(){
      const overlay = $("overlay");
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden","true");
    }

    $("closeBtn").addEventListener("click", closeModal);
    $("overlay").addEventListener("click", (e)=>{
      if(e.target === $("overlay")) closeModal();
    });

    $("sort").addEventListener("change", render);

    async function boot(){
      buildTabs();

      const res = await fetch(CSV_URL, {cache:"no-store"});
      const text = await res.text();
      allRows = parseCSV(text);

      render();
    }

    boot();
  </script>
</body>
</html>
