<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#F6F1EA" />
  <title>PeopleTalk Wine Gallery</title>
  <style>
    :root{
      --bg:#F6F1EA;      /* off-white */
      --ink:#242424;     /* graphite */
      --muted:#6A6A6A;
      --card:#FFFFFF;
      --stroke:#E7E0D6;
      --accent:#B45A3C;  /* terracotta */
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:18px;
      --radius2:14px;
      --gap:14px;
      --max:1080px;
      --font: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    a{color:inherit}
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:22px 16px 44px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand .kicker{
      font-size:12px; letter-spacing:.12em; text-transform:uppercase;
      color:var(--muted);
    }
    .brand h1{
      margin:0;
      font-size:26px;
      letter-spacing:-.02em;
      font-weight:650;
    }
    .brand .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
      max-width:520px;
    }

    .mode{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .seg{
      display:inline-flex;
      background:rgba(255,255,255,.6);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:4px;
      box-shadow:0 4px 14px rgba(0,0,0,.04);
      gap:4px;
      user-select:none;
    }
    .seg button{
      border:0;
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      color:var(--muted);
      white-space:nowrap;
    }
    .seg button[aria-pressed="true"]{
      background:var(--card);
      color:var(--ink);
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.65);
      font-size:13px;
      color:var(--muted);
      box-shadow:0 4px 14px rgba(0,0,0,.04);
    }
    select{
      font:inherit;
      border:0;
      background:transparent;
      outline:none;
      color:var(--ink);
      cursor:pointer;
    }

    /* Tabs */
    .tabs{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin:12px 0 18px;
    }
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.55);
      color:var(--muted);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      transition:transform .08s ease, background .15s ease, color .15s ease;
    }
    .tab:hover{ transform:translateY(-1px); }
    .tab[aria-pressed="true"]{
      background:var(--card);
      color:var(--ink);
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }

    /* Status */
    .status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:10px 0 16px;
      color:var(--muted);
      font-size:13px;
    }
    .status .left{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);display:inline-block}

    /* List */
    .grid{
      display:grid;
      gap:var(--gap);
    }
    @media (min-width:720px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      gap:14px;
      min-height:140px;
      position:relative;
      overflow:hidden;
    }

    /* Bottle image area: no placeholder background */
    .thumb{
      width:86px;
      min-width:86px;
      height:132px;
      border-radius:var(--radius2);
      border:1px solid rgba(0,0,0,.06);
      background:transparent; /* removed grey placeholder */
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .meta{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row1{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-weight:650;
      letter-spacing:-.01em;
      line-height:1.15;
      font-size:15px;
      margin:0;
    }
    .producer{
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }
    .line{
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }

    .prices{
      text-align:right;
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-left:8px;
    }
    .prices .p{
      font-size:12px;
      color:var(--muted);
    }
    .prices strong{
      font-size:14px;
      color:var(--ink);
      font-weight:700;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:11px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.65);
      padding:6px 9px;
      border-radius:999px;
      color:var(--muted);
      line-height:1;
    }

    .pair{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:2px;
      font-size:13px;
    }
    .pair .lbl{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .pair .txt{ color:var(--ink); }

    /* Book mode */
    .book{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.55);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .bookHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .bookHeader .secTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:220px;
    }
    .bookHeader .secTitle .h{
      font-weight:700;
      letter-spacing:-.02em;
    }
    .bookHeader .secTitle .intro{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      max-width:520px;
    }
    .bookHeader .nav{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.7);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      color:var(--ink);
      transition:transform .08s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); background:var(--card); }
    .btn:disabled{
      opacity:.45; cursor:default; transform:none;
    }
    .bookBody{
      padding:14px;
    }
    .spread{
      display:grid;
      gap:var(--gap);
    }
    @media (min-width:740px){
      .spread{ grid-template-columns: 1fr 1fr; }
    }

    .mini{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-height:120px;
      overflow:hidden;
    }
    .mini .thumb{ width:72px; min-width:72px; height:110px; }

    .footerNote{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      padding-bottom:10px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(36,36,36,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      max-width:min(560px, calc(100% - 32px));
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">PeopleTalk • Wine Gallery</div>
        <h1>Wine Gallery</h1>
        <p class="sub">Minimal, story-led list. Tap through sections, choose by feel, and pair with the menu.</p>
      </div>

      <div class="mode">
        <div class="seg" role="group" aria-label="View mode">
          <button id="btnList" aria-pressed="true" type="button">List</button>
          <button id="btnBook" aria-pressed="false" type="button">Book</button>
        </div>

        <div class="pill" title="Sorting">
          <span style="color:var(--muted)">Sort:</span>
          <select id="sortSel" aria-label="Sort wines">
            <option value="curated" selected>Curated order</option>
            <option value="price_glass_asc">Glass $ ↑</option>
            <option value="price_glass_desc">Glass $ ↓</option>
            <option value="price_bottle_asc">Bottle $ ↑</option>
            <option value="price_bottle_desc">Bottle $ ↓</option>
            <option value="name_asc">Name A→Z</option>
            <option value="region_asc">Region A→Z</option>
          </select>
        </div>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Sections">
      <button class="tab" data-sec="all" aria-pressed="true" type="button">All</button>
      <button class="tab" data-sec="sparkling" aria-pressed="false" type="button">Sparkling</button>
      <button class="tab" data-sec="white" aria-pressed="false" type="button">White</button>
      <button class="tab" data-sec="rose" aria-pressed="false" type="button">Rosé</button>
      <button class="tab" data-sec="red" aria-pressed="false" type="button">Red</button>
    </div>

    <div class="status">
      <div class="left">
        <span class="dot"></span>
        <span id="countText">Loading…</span>
      </div>
      <div id="noteText"></div>
    </div>

    <!-- LIST -->
    <div id="listView" class="grid" aria-label="Wine list"></div>

    <!-- BOOK -->
    <div id="bookView" class="book" style="display:none" aria-label="Wine book">
      <div class="bookHeader">
        <div class="secTitle">
          <div class="h" id="bookSecTitle">All wines</div>
          <div class="intro" id="bookIntro"></div>
        </div>
        <div class="nav">
          <button class="btn" id="prevBtn" type="button">Prev</button>
          <button class="btn" id="contentsBtn" type="button">Contents</button>
          <button class="btn" id="nextBtn" type="button">Next</button>
        </div>
      </div>
      <div class="bookBody">
        <div id="spread" class="spread"></div>
        <div class="footerNote" id="bookFooter"></div>
      </div>
    </div>

    <div class="footerNote">Data source: Google Sheets (CSV). Images: bottle_img (lh3.googleusercontent.com). No-image wines are hidden.</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // === CONFIG ===
    // IMPORTANT: CSV must include column headers exactly (case-sensitive):
    // id, Section, Name, Producer, Region, Country, Vintage, btg_price, bottle_price,
    // pairing_peopletalk, pairing_world_easy, visible, order, bottle_img
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7yfiUN3Wgz9vCWrKVJksRoQ6EFYzDq6P40HaN1v2hmhk0nKicji-UZYZyd7LF2-lcSSU264vG53f/pub?gid=178668445&single=true&output=csv";

    const HIDE_IF_NO_IMAGE = true;   // per your rule: bottle_img empty => hide wine
    const HIDE_IF_IMAGE_FAILS = true; // stricter: if image URL exists but fails to load => hide card

    const SECTION_INTRO = {
      all: "A compact selection, curated for clarity and pleasure.",
      sparkling: "Bright, celebratory, and food-friendly. From aperitivo to dessert.",
      white: "Fresh, aromatic, food-friendly. From crisp to creamy.",
      rose: "Chill, juicy, elegant. The easiest 'yes' with the menu.",
      red: "From silky to structured. Comfort, depth, and pairing power."
    };

    // === STATE ===
    let wines = [];
    let viewMode = "list"; // list|book
    let section = "all";   // all|sparkling|white|rose|red
    let sortMode = "curated";
    let bookPage = 0;

    // === HELPERS ===
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 1800);
    }

    function norm(v){
      if(v === undefined || v === null) return "";
      return String(v).trim();
    }
    function toNum(v){
      const x = parseFloat(String(v).replace(/[^\d.]/g,""));
      return isNaN(x) ? null : x;
    }
    function secKey(s){
      const t = norm(s).toLowerCase();
      if(t.includes("spark")) return "sparkling";
      if(t.includes("rose") || t.includes("rosé")) return "rose";
      if(t.includes("red")) return "red";
      if(t.includes("white")) return "white";
      return "other";
    }

    function parseCSV(text){
      // minimal CSV parser handling quoted fields
      const rows = [];
      let row = [];
      let cur = "";
      let inQ = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const nx = text[i+1];

        if(inQ){
          if(ch === '"' && nx === '"'){ cur += '"'; i++; }
          else if(ch === '"'){ inQ = false; }
          else { cur += ch; }
        }else{
          if(ch === '"'){ inQ = true; }
          else if(ch === ","){ row.push(cur); cur=""; }
          else if(ch === "\n"){ row.push(cur); rows.push(row); row=[]; cur=""; }
          else if(ch === "\r"){ /* ignore */ }
          else { cur += ch; }
        }
      }
      if(cur.length || row.length){ row.push(cur); rows.push(row); }

      const header = rows.shift() || [];
      const keys = header.map(h => norm(h));

      return rows
        .filter(r => r.some(c => norm(c).length))
        .map(r => {
          const obj = {};
          keys.forEach((k,idx)=> obj[k] = r[idx] !== undefined ? r[idx] : "");
          return obj;
        });
    }

    function isVisibleFlag(v){
      const t = norm(v).toLowerCase();
      return (t === "true" || t === "yes" || t === "y" || t === "1");
    }

    // === LOAD ===
    async function load(){
      $("#countText").textContent = "Loading wines…";
      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        const csv = await res.text();
        const rows = parseCSV(csv);

        wines = rows.map((row)=>({
          id: norm(row.id),
          sectionRaw: norm(row.Section || row.section),
          section: secKey(row.Section || row.section),
          name: norm(row.Name || row.name),
          producer: norm(row.Producer || row.producer),
          region: norm(row.Region || row.region),
          country: norm(row.Country || row.country),
          vintage: norm(row.Vintage || row.vintage),
          btg: toNum(row.btg_price ?? row.btg ?? row.glass ?? ""),
          bottle: toNum(row.bottle_price ?? row.bottle ?? ""),
          pairingPT: norm(row.pairing_peopletalk ?? ""),
          pairingWorld: norm(row.pairing_world_easy ?? ""),
          visible: isVisibleFlag(row.visible),
          order: toNum(row.order) ?? 9999,
          bottleImg: norm(row.bottle_img) // the only source of bottle image
        }))
        .filter(w => w.visible);

        // strict: hide if bottle_img empty
        if(HIDE_IF_NO_IMAGE){
          wines = wines.filter(w => norm(w.bottleImg).length > 0);
        }

        render();
      }catch(e){
        console.error(e);
        $("#countText").textContent = "Failed to load data.";
        $("#noteText").textContent = "Check CSV link / publish settings.";
      }
    }

    // === FILTER/SORT ===
    function filtered(){
      let list = [...wines];

      // section
      if(section !== "all"){
        list = list.filter(w => w.section === section);
      }

      // sort
      list.sort((a,b)=>{
        switch(sortMode){
          case "price_glass_asc": return (a.btg ?? 1e9) - (b.btg ?? 1e9);
          case "price_glass_desc": return (b.btg ?? -1) - (a.btg ?? -1);
          case "price_bottle_asc": return (a.bottle ?? 1e9) - (b.bottle ?? 1e9);
          case "price_bottle_desc": return (b.bottle ?? -1) - (a.bottle ?? -1);
          case "name_asc": return a.name.localeCompare(b.name);
          case "region_asc": return (a.region + a.country).localeCompare(b.region + b.country);
          case "curated":
          default:
            return (a.order - b.order) || a.name.localeCompare(b.name);
        }
      });

      return list;
    }

    // === RENDER ===
    function render(){
      const list = filtered();
      $("#noteText").textContent = "";
      $("#countText").textContent = `${list.length} wines · section: ${section === "all" ? "All" : cap(section)}`;

      if(viewMode === "list"){
        renderList(list);
      }else{
        renderBook(list);
      }
    }

    function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    function mkChips(w){
      const chips = [];
      if(w.section && w.section !== "other") chips.push(cap(w.section));
      if(w.country) chips.push(w.country);
      if(w.region) chips.push(w.region);
      return chips;
    }

    function priceLine(w){
      const g = (w.btg != null) ? `$${w.btg}` : "—";
      const b = (w.bottle != null) ? `$${w.bottle}` : "—";
      return {g,b};
    }

    function buildCard(w, compact=false){
      const card = document.createElement("div");
      card.className = compact ? "mini" : "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = `${w.name} bottle`;
      img.src = w.bottleImg;

      // If image fails: hide the whole card (no placeholders)
      img.onerror = () => {
        if(HIDE_IF_IMAGE_FAILS){
          card.remove();
        }else{
          img.remove();
        }
      };

      thumb.appendChild(img);

      const meta = document.createElement("div");
      meta.className = "meta";

      const row1 = document.createElement("div");
      row1.className = "row1";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const h = document.createElement("p");
      h.className = "title";
      h.textContent = w.name;

      const prod = document.createElement("div");
      prod.className = "producer";
      prod.textContent = w.producer;

      const line = document.createElement("div");
      line.className = "line";
      const region = [w.region, w.country].filter(Boolean).join(", ");
      const grape = norm(w.vintage) ? ` • ${w.vintage}` : "";
      line.textContent = `${region}${grape}`;

      left.appendChild(h);
      left.appendChild(prod);
      left.appendChild(line);

      const prices = document.createElement("div");
      prices.className = "prices";
      const pr = priceLine(w);

      // pairing first, then price (your confirmed order)
      // price block:
      const p1 = document.createElement("div");
      p1.className = "p";
      p1.innerHTML = `Glass <strong>${pr.g}</strong>`;
      const p2 = document.createElement("div");
      p2.className = "p";
      p2.innerHTML = `Bottle <strong>${pr.b}</strong>`;
      prices.appendChild(p1);
      prices.appendChild(p2);

      row1.appendChild(left);
      row1.appendChild(prices);

      const chipsWrap = document.createElement("div");
      chipsWrap.className = "chips";
      mkChips(w).forEach(t=>{
        const c = document.createElement("span");
        c.className = "chip";
        c.textContent = t;
        chipsWrap.appendChild(c);
      });

      const pairPT = document.createElement("div");
      pairPT.className = "pair";
      const lbl1 = document.createElement("div");
      lbl1.className = "lbl";
      lbl1.textContent = "PeopleTalk pairing";
      const txt1 = document.createElement("div");
      txt1.className = "txt";
      txt1.textContent = w.pairingPT || "—";
      pairPT.appendChild(lbl1);
      pairPT.appendChild(txt1);

      const pairW = document.createElement("div");
      pairW.className = "pair";
      const lbl2 = document.createElement("div");
      lbl2.className = "lbl";
      lbl2.textContent = "World classic (easy)";
      const txt2 = document.createElement("div");
      txt2.className = "txt";
      txt2.textContent = w.pairingWorld || "—";
      pairW.appendChild(lbl2);
      pairW.appendChild(txt2);

      meta.appendChild(row1);
      meta.appendChild(chipsWrap);
      meta.appendChild(pairPT);
      meta.appendChild(pairW);

      card.appendChild(thumb);
      card.appendChild(meta);

      return card;
    }

    function renderList(list){
      $("#listView").style.display = "";
      $("#bookView").style.display = "none";

      const root = $("#listView");
      root.innerHTML = "";
      list.forEach(w=>{
        root.appendChild(buildCard(w, false));
      });
    }

    function renderBook(list){
      $("#listView").style.display = "none";
      $("#bookView").style.display = "";

      const perPage = 4; // 2–3 wines per spread was requested; using 4 for a 2x2 grid. can be tuned later.
      const pages = Math.max(1, Math.ceil(list.length / perPage));
      bookPage = Math.min(bookPage, pages - 1);

      const start = bookPage * perPage;
      const slice = list.slice(start, start + perPage);

      $("#bookSecTitle").textContent = section === "all" ? "All wines" : `${cap(section)} wines`;
      $("#bookIntro").textContent = SECTION_INTRO[section] || "";

      $("#prevBtn").disabled = (bookPage === 0);
      $("#nextBtn").disabled = (bookPage >= pages - 1);
      $("#bookFooter").textContent = `Page ${bookPage + 1} of ${pages}`;

      const spread = $("#spread");
      spread.innerHTML = "";
      slice.forEach(w=>{
        spread.appendChild(buildCard(w, true));
      });
    }

    // === EVENTS ===
    $("#btnList").addEventListener("click", ()=>{
      viewMode = "list";
      $("#btnList").setAttribute("aria-pressed","true");
      $("#btnBook").setAttribute("aria-pressed","false");
      render();
    });
    $("#btnBook").addEventListener("click", ()=>{
      viewMode = "book";
      $("#btnList").setAttribute("aria-pressed","false");
      $("#btnBook").setAttribute("aria-pressed","true");
      render();
    });

    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        $$(".tab").forEach(b=>b.setAttribute("aria-pressed","false"));
        btn.setAttribute("aria-pressed","true");
        section = btn.dataset.sec;
        bookPage = 0;
        render();
      });
    });

    $("#sortSel").addEventListener("change", (e)=>{
      sortMode = e.target.value;
      bookPage = 0;
      render();
    });

    $("#prevBtn").addEventListener("click", ()=>{
      bookPage = Math.max(0, bookPage - 1);
      render();
    });
    $("#nextBtn").addEventListener("click", ()=>{
      bookPage = bookPage + 1;
      render();
    });
    $("#contentsBtn").addEventListener("click", ()=>{
      // "Contents" reset to All section (keeps MVP simple)
      section = "all";
      bookPage = 0;
      $$(".tab").forEach(b=>b.setAttribute("aria-pressed", b.dataset.sec === "all" ? "true" : "false"));
      toast("Contents");
      render();
    });

    // === START ===
    load();
  </script>
</body>
</html>
